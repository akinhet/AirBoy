#include <stdio.h>
#include <string.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <esp_random.h>

#include "display.h"
#include "input.h"
#include "array.h"
#include "text.h"

#include "graphics.h"

#define TASKNAME "main"

typedef enum {
I = 0, J, L, O, S, T, Z
} piece;

static struct {
	int x, y;
	piece type;
	int rotation;
	Sprite blocks[4];
} tetromino;

tetromino.x = tetromino.y = 0;
tetromino.rotation = 0;
tetromino.type = I;

const uint8_t block_lookup[7][4][4][2] = {
	{
		{{0,1},
		 {1,1},
		 {2,1},
		 {3,1}},
		{{2,0},
		 {2,1},
		 {2,2},
		 {2,3}},
		{{0,2},
		 {1,2},
		 {2,2},
		 {3,2}},
		{{1,0},
		 {1,1},
		 {1,2},
		 {1,3}},
	},
	{
		{{0,0},
		 {0,1},
		 {1,1},
		 {1,2}},
		{{1,0},
		 {2,0},
		 {1,1},
		 {1,2}},
		{{0,1},
		 {1,1},
		 {2,1},
		 {2,2}},
		{{1,0},
		 {1,1},
		 {1,2},
		 {0,2}},
	},
	{
		{{2,0},
		 {2,1},
		 {1,1},
		 {0,1}},
		{{1,0},
		 {1,1},
		 {1,2},
		 {2,2}},
		{{0,1},
		 {1,1},
		 {2,1},
		 {0,2}},
		{{0,0},
		 {1,0},
		 {1,1},
		 {1,2}},
	},
	{
		{{0,0},
		 {1,0},
		 {0,1},
		 {1,1}},
		{{0,0},
		 {1,0},
		 {0,1},
		 {1,1}},
		{{0,0},
		 {1,0},
		 {0,1},
		 {1,1}},
		{{0,0},
		 {1,0},
		 {0,1},
		 {1,1}},
	},
	{
		{{1,0},
		 {2,0},
		 {0,1},
		 {1,1}},
		{{1,0},
		 {1,1},
		 {2,1},
		 {2,2}},
		{{1,1},
		 {2,1},
		 {0,2},
		 {1,2}},
		{{0,0},
		 {0,1},
		 {1,1},
		 {1,2}},
	},
	{
		{{1,0},
		 {0,1},
		 {1,1},
		 {2,1}},
		{{1,0},
		 {1,1},
		 {2,1},
		 {1,2}},
		{{0,1},
		 {1,1},
		 {2,1},
		 {1,2}},
		{{1,0},
		 {0,1},
		 {1,1},
		 {1,2}},
	},
	{
		{{0,0},
		 {0,1},
		 {1,1},
		 {2,1}},
		{{2,0},
		 {1,1},
		 {2,1},
		 {1,2}},
		{{0,1},
		 {1,1},
		 {1,2},
		 {1,2}},
		{{1,0},
		 {0,1},
		 {1,1},
		 {0,2}},
	},
};

const _Bool piece_lookup[7][4][16] = {
	{
		{0,0,0,0,
		 1,1,1,1,
		 0,0,0,0,
		 0,0,0,0,},
		{0,0,1,0,
		 0,0,1,0,
		 0,0,1,0,
		 0,0,1,0,},
		{0,0,0,0,
		 0,0,0,0,
		 1,1,1,1,
		 0,0,0,0,},
		{0,1,0,0,
		 0,1,0,0,
		 0,1,0,0,
		 0,1,0,0,},
	},
	{
		{1,0,0,0,
		 1,1,1,0,
		 0,0,0,0,
		 0,0,0,0,},
		{0,1,1,0,
		 0,1,0,0,
		 0,1,0,0,
		 0,0,0,0,},
		{0,0,0,0,
		 1,1,1,0,
		 0,0,1,0,
		 0,0,0,0,},
		{0,1,0,0,
		 0,1,0,0,
		 1,1,0,0,
		 0,0,0,0,},
	},
	{
		{0,0,1,0,
		 1,1,1,0,
		 0,0,0,0,
		 0,0,0,0,},
		{0,1,0,0,
		 0,1,0,0,
		 0,1,1,0,
		 0,0,0,0,},
		{0,0,0,0,
		 1,1,1,0,
		 1,0,0,0,
		 0,0,0,0,},
		{1,1,0,0,
		 0,1,0,0,
		 0,1,0,0,
		 0,0,0,0,},
	},
	{
		{1,1,0,0,
		 1,1,0,0,
		 0,0,0,0,
		 0,0,0,0,},
		{1,1,0,0,
		 1,1,0,0,
		 0,0,0,0,
		 0,0,0,0,},
		{1,1,0,0,
		 1,1,0,0,
		 0,0,0,0,
		 0,0,0,0,},
		{1,1,0,0,
		 1,1,0,0,
		 0,0,0,0,
		 0,0,0,0,},
	},
	{
		{0,1,1,0,
		 1,1,0,0,
		 0,0,0,0,
		 0,0,0,0,},
		{0,1,0,0,
		 0,1,1,0,
		 0,0,1,0,
		 0,0,0,0,},
		{0,0,0,0,
		 0,1,1,0,
		 1,1,0,0,
		 0,0,0,0,},
		{1,0,0,0,
		 1,1,0,0,
		 0,1,0,0,
		 0,0,0,0,},
	},
	{
		{0,1,0,0,
		 1,1,1,0,
		 0,0,0,0,
		 0,0,0,0,},
		{0,1,0,0,
		 0,1,1,0,
		 0,1,0,0,
		 0,0,0,0,},
		{0,0,0,0,
		 1,1,1,0,
		 0,1,0,0,
		 0,0,0,0,},
		{0,1,0,0,
		 1,1,0,0,
		 0,1,0,0,
		 0,0,0,0,},
	},
	{
		{1,1,0,0,
		 0,1,1,0,
		 0,0,0,0,
		 0,0,0,0,},
		{0,0,1,0,
		 0,1,1,0,
		 0,1,0,0,
		 0,0,0,0,},
		{0,0,0,0,
		 1,1,0,0,
		 0,1,1,0,
		 0,0,0,0,},
		{0,1,0,0,
		 1,1,0,0,
		 1,0,0,0,
		 0,0,0,0,},
	},
};

const Sprite block[30] = {
{0, 0, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 16, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 32, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 48, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 64, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 80, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 96, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 112, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 128, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 144, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 160, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 176, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 192, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 208, 16, 16, blocks[1], 1,0,0,0,0,0,},
{0, 224, 16, 16, blocks[1], 1,0,0,0,0,0,},
{16, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{32, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{48, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{64, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{80, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{96, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{112, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{128, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
{144, 0, 16, 16, blocks[0], 1,0,0,0,0,0,},
/* {160, 0, 16, 16, blocks[3], 1,0,0,0,0,0,}, */
/* {176, 0, 16, 16, blocks[3], 1,0,0,0,0,0,}, */
/* {192, 0, 16, 16, blocks[3], 1,0,0,0,0,0,}, */
/* {208, 0, 16, 16, blocks[3], 1,0,0,0,0,0,}, */
/* {224, 0, 16, 16, blocks[3], 1,0,0,0,0,0,}, */
};


int clamp(int a, int min, int max)
{
    return a > min ? (a < max ? a : max) : min;
}


void set_blocks()
{
	Sprite temp = {};
	memset(&temp, 0, sizeof(Sprite));

	temp.x = piece_lookup
}


void app_main(void)
{
	setupDisplay();
	setupInput();

	Input input;
	/* Array player; */
	/* initArray(&player, 10); */
	/* insertArray(&player, body_segment); */
	/* insertArray(&player, body_segment); */
	/* insertArray(&player, body_segment); */

	tetromino.blocks[0] = ;

	long long int time = esp_timer_get_time();

	while (true) {
		input = pollInput();

		/* if (input.dpad_up && prevdir != DOWN) */
		/* 	direction = UP; */
		/* else if (input.dpad_right && prevdir != LEFT) */
		/* 	direction = RIGHT; */
		/* else if (input.dpad_left && prevdir != RIGHT) */
		/* 	direction = LEFT; */
		/* else if (input.dpad_down && prevdir != UP) */
		/* 	direction = DOWN; */

		if (esp_timer_get_time() - time > 200000) {
			time = esp_timer_get_time();

			memset(framebuffer, 0, sizeof(framebuffer));
			//memset(framebuffer, esp_random(), sizeof(framebuffer));
			//esp_fill_random(framebuffer, sizeof(framebuffer));

			/* for (int i = 0; i < 4; i++) { */
			/* 	drawSprite(tetromino.blocks[i], framebuffer); */
			/* } */
		}

		frameDraw(framebuffer);
		vTaskDelay(10 / portTICK_PERIOD_MS);
	}
}
